!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=10)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"validator",{enumerable:!0,get:function(){return o.validator}}),Object.defineProperty(t,"limiter",{enumerable:!0,get:function(){return n.limiter}}),Object.defineProperty(t,"authenticate",{enumerable:!0,get:function(){return s.authenticate}}),Object.defineProperty(t,"ValidationError",{enumerable:!0,get:function(){return a.ValidationError}}),Object.defineProperty(t,"NotFoundError",{enumerable:!0,get:function(){return a.NotFoundError}}),Object.defineProperty(t,"getPort",{enumerable:!0,get:function(){return i.getPort}}),Object.defineProperty(t,"getDbName",{enumerable:!0,get:function(){return i.getDbName}}),Object.defineProperty(t,"getDbUrl",{enumerable:!0,get:function(){return i.getDbUrl}}),Object.defineProperty(t,"getDbPort",{enumerable:!0,get:function(){return i.getDbPort}});var o=r(14),n=r(16),s=r(18),a=r(2),i=r(24)},function(e,t){e.exports=require("debug")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"NotFoundError",{enumerable:!0,get:function(){return o.NotFoundError}}),Object.defineProperty(t,"ValidationError",{enumerable:!0,get:function(){return n.ValidationError}});var o=r(22),n=r(23)},function(e,t){e.exports=require("express")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"users",{enumerable:!0,get:function(){return o.users}}),Object.defineProperty(t,"jwt",{enumerable:!0,get:function(){return n.jwt}}),Object.defineProperty(t,"todos",{enumerable:!0,get:function(){return s.todos}});var o=r(19),n=r(20),s=r(21)},function(e,t){e.exports=require("mongoose")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"Auth",{enumerable:!0,get:function(){return o.Auth}}),Object.defineProperty(t,"Users",{enumerable:!0,get:function(){return n.Users}}),Object.defineProperty(t,"Todos",{enumerable:!0,get:function(){return s.Todos}});var o=r(33),n=r(40),s=r(41)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"Auth",{enumerable:!0,get:function(){return o.Auth}}),Object.defineProperty(t,"Users",{enumerable:!0,get:function(){return n.Users}}),Object.defineProperty(t,"Todos",{enumerable:!0,get:function(){return s.Todos}});var o=r(34),n=r(38),s=r(39)},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("bcryptjs")},function(e,t,r){"use strict";var o,n=(o=r(1))&&o.__esModule?o:{default:o},s=r(11);const a=(0,r(0).getPort)(),i=(0,n.default)("server:main");s.app.listen(a,()=>{i(`Server API is up on port ${a}`)})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;var o=d(r(3)),n=d(r(12)),s=d(r(13)),a=d(r(1)),i=r(0);r(29);var u=r(30);function d(e){return e&&e.__esModule?e:{default:e}}const c=(0,o.default)();t.app=c;const l=(0,a.default)("server:init");c.use((0,s.default)()),c.use((e,t,r)=>{let o=e.headers.origin||"http://localhost:3000";t.header("Access-Control-Allow-Origin",o),t.header("Access-Control-Allow-Credentials","true"),t.header("Access-Control-Allow-Methods","GET, PUT, POST, DELETE, OPTIONS"),t.header("Access-Control-Allow-Headers","Content-Type, Authorization, Authentication, Content-Length, X-Requested-With, Cache"),"OPTIONS"===e.method?t.sendStatus(204):r()}),c.use(n.default.json({limit:"5kb"})),c.use("/api",[u.auth,u.users,u.todos]),c.use("*",(e,t,r)=>{r(new i.NotFoundError(`Can not find right route for method ${e.method} and path ${e.originalUrl}`,404))}),c.use((e,t,r,o)=>{const{name:n,message:s,statusCode:a}=e;l(`Error: ${`${n}: ${s}`}`);const i=a||500;r.status(i).json({message:s})})},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("helmet")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validator=void 0;var o,n=(o=r(15))&&o.__esModule?o:{default:o},s=r(0);t.validator=e=>(t,r,o)=>{const a=new n.default({allErrors:!0}).compile(e);if(a(t.body))o();else{const e=a.errors.map(({message:e})=>e).join(", "),r=JSON.stringify(t.body,null,2);o(new s.ValidationError(`${t.method}: ${t.originalUrl} [ ${e} ]\n${r}`))}}},function(e,t){e.exports=require("ajv")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.limiter=void 0;var o,n=(o=r(17))&&o.__esModule?o:{default:o};t.limiter=(e,t)=>(0,n.default)({windowMs:t,max:e,headers:!1})},function(e,t){e.exports=require("express-rate-limit")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.authenticate=void 0;var o=r(8),n=(r(0),r(4));t.authenticate=async(e,t,r)=>{const s=e.get("x-token"),a=await n.jwt.findOne({token:s}).lean();if(!a)return t.status(401).json({message:"credentials are not valid"});try{const t=(0,o.verify)(s,a.key),{id:n,email:i,fname:u,lname:d}=t;e.user={id:n,email:i,fname:u,lname:d},r()}catch(e){t.status(401).json({message:"credentials are not valid"})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.users=void 0;var o=s(r(5)),n=s(r(9));function s(e){return e&&e.__esModule?e:{default:e}}const a=new o.default.Schema({fname:{type:String,required:!0},lname:{type:String,required:!0},email:{type:String,required:!0,unique:!0,index:!0},password:{type:String,required:!0,set:e=>n.default.hashSync(e,11)}},{timestamps:{createdAt:"created",updatedAt:"modified"}}),i=o.default.model("users",a);t.users=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jwt=void 0;var o,n=(o=r(5))&&o.__esModule?o:{default:o};const s=new n.default.Schema({token:{type:String,required:!0},key:{type:String,required:!0}},{timestamps:{createdAt:"created",updatedAt:!1}});s.index({created:1},{expireAfterSeconds:3600});const a=n.default.model("jwt",s);t.jwt=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.todos=void 0;var o,n=(o=r(5))&&o.__esModule?o:{default:o};const s=new n.default.Schema({uid:{type:n.default.Schema.Types.ObjectId,ref:"users",required:!0,index:!0},name:{type:String,required:!0},description:{type:String,required:!0},dd:{type:Date,required:!0},status:{type:String,required:!0,index:!0,enum:["new","completed"],default:"new",set:e=>e.toLowerCase()}},{timestamps:{createdAt:"created",updatedAt:"modified"}});s.index({text:"text"});const a=n.default.model("todos",s);t.todos=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotFoundError=void 0;class o extends Error{constructor(...e){super(...e);const[,t=404]=e;if("number"!=typeof t)throw new Error("can not construct NotFoundError due to arguments error");if(!/^[1-5]{1}[0-9]{2}$/.test(t))throw new Error("statusCode in NotFoundError should be a number in range from 100 to 599");Error.captureStackTrace(this,o),this.name="NotFoundError",this.statusCode=t}}t.NotFoundError=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ValidationError=void 0;class o extends Error{constructor(...e){super(...e);const[,t=400]=e;if("number"!=typeof t)throw new Error("can not construct ValidationError due to arguments error");if(!/^[1-5]{1}[0-9]{2}$/.test(t))throw new Error("statusCode in ValidationError should be a number in range from 100 to 599");Error.captureStackTrace(this,o),this.name="ValidationError",this.statusCode=t}}t.ValidationError=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"getPort",{enumerable:!0,get:function(){return o.getPort}}),Object.defineProperty(t,"getDbUrl",{enumerable:!0,get:function(){return n.getDbUrl}}),Object.defineProperty(t,"getDbName",{enumerable:!0,get:function(){return s.getDbName}}),Object.defineProperty(t,"getDbPort",{enumerable:!0,get:function(){return a.getDbPort}});var o=r(25),n=r(26),s=r(27),a=r(28)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPort=void 0;var o=r(2);t.getPort=()=>{const{PORT:e}=process.env;if(!e)throw new o.ValidationError("Environment variable PORT should be specified");if(!/^[3-9]{1}[0-9]{3}$/.test(e))throw new o.ValidationError("Environment variable PORT should a number and be between 3000 and 9999");return e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDbUrl=void 0;var o=r(2);t.getDbUrl=()=>{const{DB_URL:e}=process.env;if(!e)throw new o.ValidationError("Environment variable DB_URL should be specified");if("string"!=typeof e)throw new o.ValidationError("Environment variable DB_URL should be a string");return e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDbName=void 0;var o=r(2);t.getDbName=()=>{const{DB_NAME:e}=process.env;if(!e)throw new o.ValidationError("Environment variable DB_NAME should be specified");if("string"!=typeof e)throw new o.ValidationError("Environment variable DB_NAME should be a string");return e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDbPort=void 0;var o=r(2);t.getDbPort=()=>{const{DB_PORT:e}=process.env;if(!e)throw new o.ValidationError("Environment variable DB_PORT should be specified");if("number"!=typeof parseInt(e,10))throw new o.ValidationError("Environment variable DB_PORT should be a string");return e}},function(e,t,r){"use strict";var o=a(r(5)),n=a(r(1)),s=r(0);function a(e){return e&&e.__esModule?e:{default:e}}const i=(0,n.default)("db"),u=(0,s.getDbName)(),d=(0,s.getDbUrl)(),c=(0,s.getDbPort)(),l={promiseLibrary:global.Promise,poolSize:10,keepAlive:3e4,connectTimeoutMS:5e3,useNewUrlParser:!0,useFindAndModify:!1,useCreateIndex:!0,useUnifiedTopology:!0};o.default.connect(`mongodb://${d}:${c}/${u}`,l).then(()=>{i(`DB '${u}' connected`)}).catch(({message:e})=>{i(`DB ${u} connectionError: ${e}`)})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"auth",{enumerable:!0,get:function(){return o.auth}}),Object.defineProperty(t,"users",{enumerable:!0,get:function(){return n.users}}),Object.defineProperty(t,"todos",{enumerable:!0,get:function(){return s.todos}});var o=r(31),n=r(42),s=r(44)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.auth=void 0;var o,n=(o=r(3))&&o.__esModule?o:{default:o},s=r(0),a=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=i();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var s=o?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(r,n,s):r[n]=e[n]}r.default=e,t&&t.set(e,r);return r}(r(32));function i(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return i=function(){return e},e}const u=n.default.Router();t.auth=u;u.post("/v1/auth/login",[(0,s.limiter)(10,6e4)],a.login)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.login=void 0;var o,n=(o=r(1))&&o.__esModule?o:{default:o},s=r(6);const a=(0,n.default)("router:auth");t.login=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{if(!e.headers.authorization)throw new Error("credentials are not valid");const[r,o]=e.headers.authorization.split(" ");if("Basic"!==r)throw new Error("you should use basic authentication type");const[n,a]=Buffer.from(o,"base64").toString().split(":"),i=new s.Auth({email:n,password:a}),u=await i.login();t.set("X-Token",u),t.sendStatus(204)}catch(e){t.status(401).json({message:e.message})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Auth=void 0;var o=r(7);t.Auth=class{constructor(e){this.models={auth:new o.Auth(e)}}async login(){const{auth:e}=this.models;return await e.login()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Auth=void 0;var o=c(r(9)),n=c(r(8)),s=c(r(35)),a=r(36),i=r(37),u=r(4),d=r(0);function c(e){return e&&e.__esModule?e:{default:e}}t.Auth=class{constructor(e){this.data=e,this.odm=u.users,this.createPrivateKey=(0,i.promisify)(s.default.createPrivateKey)}async login(){const{email:e,password:t}=this.data,r=await this.odm.findOne({email:e}).select("password hash email fname lname weight height").lean();if(!r)throw new d.NotFoundError("credentials are not valid");const{_id:s,password:i,email:c,fname:l,lname:f}=r;if(!await o.default.compare(t,i))throw new d.NotFoundError("credentials are not valid");const{key:p}=await this.createPrivateKey(2048,{password:(0,a.v4)()}),m=n.default.sign({id:s,email:c,fname:l,lname:f},p,{expiresIn:"1h"});return await u.jwt.create({token:m,key:p}),m}}},function(e,t){e.exports=require("pem")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("util")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Users=void 0;var o=r(4);t.Users=class{constructor(e){this.data=e,this.odm=o.users}async read(){const{email:e}=this.data,t=await this.odm.findOne({email:e}).lean(),{email:r,fname:o,lname:n}=t;return{email:r,fname:o,lname:n}}async create(){const e=await this.odm.create(this.data),{email:t,fname:r,lname:o}=e;return{email:t,fname:r,lname:o}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Todos=void 0;var o=r(4);class n{constructor(e){this.data=e,this.odm=o.todos}async read(){const{id:e}=this.data;return(await this.odm.find({uid:e}).sort("-created").select("-__v -modified -uid").lean()).map(({_id:e,status:t,name:r,description:o,dd:n,created:s})=>({id:e,status:t,name:r,description:o,dd:n,created:s}))}async readById(){const{uid:e,todoId:t}=this.data,r=await this.odm.findOne({_id:t,uid:e}).select("-__v -modified").lean();if(!r)throw new Error("todo not found");const{_id:o,status:n,name:s,description:a,dd:i,created:u}=r;return{id:o,status:n,name:s,description:a,dd:i,created:u}}async create(){return await this.odm.create(this.data),!0}async update(){const{uid:e,todoId:t}=this.data,r=n.formatUpdateQuery(this.data);if(!await this.odm.findOneAndUpdate({_id:t,uid:e},r))throw new Error("todo not found");return!0}async remove(){const{uid:e,todoId:t}=this.data;if(!await this.odm.findOneAndRemove({_id:t,uid:e}))throw new Error("todo not found");return!0}static formatUpdateQuery(e){const t={},{name:r,description:o,status:n,dd:s}=e;return r&&(t.name=r),o&&(t.description=o),n&&(t.status=n),s&&(t.dd=s),t}}t.Todos=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Users=void 0;var o=r(7);t.Users=class{constructor(e){this.models={users:new o.Users(e)}}async read(){const{users:e}=this.models;return await e.read()}async readById(){const{users:e}=this.models;return await e.readById()}async create(){const{users:e}=this.models;return await e.create()}async update(){const{users:e}=this.models;return await e.update()}async remove(){const{users:e}=this.models;return await e.remove()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Todos=void 0;var o=r(7);t.Todos=class{constructor(e){this.models={todos:new o.Todos(e)}}async read(){const{todos:e}=this.models;return await e.read()}async readById(){const{todos:e}=this.models;return await e.readById()}async create(){const{todos:e}=this.models;return await e.create()}async update(){const{todos:e}=this.models;return await e.update()}async remove(){const{todos:e}=this.models;return await e.remove()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.users=void 0;var o,n=(o=r(3))&&o.__esModule?o:{default:o},s=r(0),a=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=i();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var s=o?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(r,n,s):r[n]=e[n]}r.default=e,t&&t.set(e,r);return r}(r(43));function i(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return i=function(){return e},e}const u=n.default.Router();t.users=u;u.get("/v1/users",[(0,s.limiter)(10,6e4),s.authenticate],a.get),u.post("/v1/users",[(0,s.limiter)(10,6e4)],a.post)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.post=t.get=void 0;var o,n=(o=r(1))&&o.__esModule?o:{default:o},s=r(6);const a=(0,n.default)("router:users");t.get=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const r=new s.Users(e.user),o=await r.read();t.status(200).json({data:o})}catch(e){t.status(400).json({message:e.message})}};t.post=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const r=new s.Users(e.body),o=await r.create();t.status(201).json({data:o})}catch({name:r,message:o}){if("MongoError"===r&&o.startsWith("E11000")){const{email:r}=e.body;return t.status(500).json({message:`user with email '${r}' already registered`})}t.status(400).json({message:o})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.todos=void 0;var o,n=(o=r(3))&&o.__esModule?o:{default:o},s=r(0),a=d(r(45)),i=d(r(46));function u(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return u=function(){return e},e}function d(e){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=u();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var s=o?Object.getOwnPropertyDescriptor(e,n):null;s&&(s.get||s.set)?Object.defineProperty(r,n,s):r[n]=e[n]}return r.default=e,t&&t.set(e,r),r}const c=n.default.Router();t.todos=c;c.get("/v1/todos/:id",[(0,s.limiter)(10,6e4),s.authenticate],a.getById),c.get("/v2/todos",[(0,s.limiter)(10,6e4),s.authenticate],i.get),c.post("/v2/todos",[(0,s.limiter)(10,6e4),s.authenticate],i.post),c.put("/v2/todos/:id",[(0,s.limiter)(10,6e4),s.authenticate],i.put),c.delete("/v2/todos/:id",[(0,s.limiter)(10,6e4),s.authenticate],i.remove)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getById=void 0;var o,n=(o=r(1))&&o.__esModule?o:{default:o},s=r(6);const a=(0,n.default)("router:todos:v1");t.getById=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const{id:r}=e.params,o={uid:e.user.id,todoId:r,...e.body},n=new s.Todos(o),a=await n.readById();t.status(200).json({data:a})}catch(e){t.status(400).json({message:e.message})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.remove=t.put=t.post=t.get=void 0;var o,n=(o=r(1))&&o.__esModule?o:{default:o},s=r(6);const a=(0,n.default)("router:todos:v2");t.get=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const r=new s.Todos(e.user),o=await r.read();t.status(200).json({data:o})}catch(e){t.status(400).json({message:e.message})}};t.post=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const r={...e.body,uid:e.user.id},o=new s.Todos(r);await o.create(),t.status(201).json({data:"todo created"})}catch({name:e,message:r}){t.status(400).json({message:r})}};t.put=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const{id:r}=e.params,o={uid:e.user.id,todoId:r,...e.body},n=new s.Todos(o);await n.update(),t.sendStatus(204)}catch({name:e,message:r}){t.status(400).json({message:r})}};t.remove=async(e,t)=>{a(`${e.method} — ${e.originalUrl}`);try{const{id:r}=e.params,o={uid:e.user.id,todoId:r},n=new s.Todos(o);await n.remove(),t.sendStatus(204)}catch({name:e,message:r}){t.status(400).json({message:r})}}}]);